import{_ as i,c as a,o as e,a6 as n}from"./chunks/framework.CHl2ywxc.js";const c=JSON.parse('{"title":"Phase 7: OAuth Flow Handling Architecture","description":"","frontmatter":{},"headers":[],"relativePath":"architecture/phase7-architecture.md","filePath":"architecture/phase7-architecture.md","lastUpdated":1755281500000}'),t={name:"architecture/phase7-architecture.md"};function l(h,s,r,p,k,d){return e(),a("div",null,s[0]||(s[0]=[n(`<h1 id="phase-7-oauth-flow-handling-architecture" tabindex="-1">Phase 7: OAuth Flow Handling Architecture <a class="header-anchor" href="#phase-7-oauth-flow-handling-architecture" aria-label="Permalink to &quot;Phase 7: OAuth Flow Handling Architecture&quot;">​</a></h1><p>This document defines the comprehensive OAuth flow handling system for the Master MCP Server. It builds on Phases 1–6 to provide secure, user‑friendly, and provider‑agnostic OAuth authorization flows with PKCE, state/nonce protections, accessible web interfaces, and deep integration with the existing authentication system and configuration framework.</p><h2 id="goals-and-scope" tabindex="-1">Goals and Scope <a class="header-anchor" href="#goals-and-scope" aria-label="Permalink to &quot;Goals and Scope&quot;">​</a></h2><ul><li>First‑class Authorization Code with PKCE for public clients (web, mobile, desktop/CLI).</li><li>Delegation and on‑behalf‑of (OBO) flows for backend and multi‑service topologies.</li><li>Provider‑specific customizations while preserving a stable core abstraction.</li><li>Mobile‑friendly, accessible, internationalized consent and callback pages.</li><li>Robust security: PKCE, state, nonce (OIDC), strict redirect validation, replay protection.</li><li>End‑to‑end integration with MultiAuthManager (Phase 2), RequestRouter (Phase 3–4), and ConfigManager (Phase 5–6).</li><li>Cross‑platform deployability: Node.js and edge/serverless (Cloudflare Workers) with consistent behavior.</li></ul><hr><h2 id="core-components" tabindex="-1">Core Components <a class="header-anchor" href="#core-components" aria-label="Permalink to &quot;Core Components&quot;">​</a></h2><ul><li>OAuthFlowController: Orchestrates end‑to‑end flows; routes start/callback/retry; coordinates PKCE/State and invokes providers.</li><li>PKCEManager: Generates S256 code verifier/challenge, validates method support, and binds to session state.</li><li>StateManager: CSRF state and OIDC nonce issuance/validation; single‑use, time‑bounded entries.</li><li>CallbackHandler: Validates callback requests, performs token exchange, handles error mapping and idempotency.</li><li>WebInterfaceRenderer: Renders HTML pages (start/consent/success/error/retry) with i18n, branding, and accessibility.</li><li>FlowValidator: Centralized validation and security checks (redirect allowlist, provider enablement, policy gates).</li></ul><p>Supporting services from prior phases:</p><ul><li>MultiAuthManager (Phase 2): Strategy selection and token lifecycle; receives final TokenBundle.</li><li>OAuthProviderRegistry (Phase 2): Provider abstraction (buildAuthUrl, refresh, revoke, userinfo, etc.).</li><li>RequestRouter (Phase 3–4): Endpoint routing, circuit breaker and retry around provider network calls.</li><li>ProtocolHandler + DependencyContainer (Phase 5): Wiring and lifecycle.</li><li>ConfigManager (Phase 5–6): Typed settings for providers, UI, security, and platform adapters.</li></ul><div class="language-mermaid vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">classDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  class OAuthFlowController {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    +start(req): HttpResponse</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    +callback(req): HttpResponse</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    +retry(req): HttpResponse</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    -pkce: PKCEManager</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    -state: StateManager</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    -cb: CallbackHandler</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    -ui: WebInterfaceRenderer</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    -validator: FlowValidator</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    -auth: MultiAuthManager</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  class PKCEManager {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    +issue(): {verifier:string, challenge:string, method:&#39;S256&#39;}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    +hash(verifier): string</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    +validate(verifier, storedHash): boolean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  class StateManager {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    +issue(input): Promise~StateToken~</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    +validate(stateToken): Promise~StateRecord~</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    +invalidate(id): Promise~void~</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  class CallbackHandler {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    +exchange(provider, code, verifier, redirectUri): Promise~TokenBundle~</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    +finalize(session, tokens): Promise~HttpResponse~</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  class WebInterfaceRenderer {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    +render(page, model, locale): HttpResponse</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  class FlowValidator {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    +checkProviderEnabled(providerId)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    +checkRedirectAllowed(providerId, redirectUri)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    +checkPkceRequired(providerId)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    +checkScopesAllowed(providerId, scopes)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  OAuthFlowController --&gt; PKCEManager</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  OAuthFlowController --&gt; StateManager</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  OAuthFlowController --&gt; CallbackHandler</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  OAuthFlowController --&gt; WebInterfaceRenderer</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  OAuthFlowController --&gt; FlowValidator</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  OAuthFlowController --&gt; MultiAuthManager</span></span></code></pre></div><hr><h2 id="endpoint-structure-and-routing" tabindex="-1">Endpoint Structure and Routing <a class="header-anchor" href="#endpoint-structure-and-routing" aria-label="Permalink to &quot;Endpoint Structure and Routing&quot;">​</a></h2><p>Canonical OAuth endpoints (mounted under configurable <code>basePath</code>, default <code>/oauth</code>):</p><ul><li><code>GET /oauth/:provider/start</code> → Initiate flow; creates state/PKCE; redirects to provider authorize URL or renders interstitial consent.</li><li><code>GET /oauth/:provider/callback</code> → Process provider callback; validate state/nonce; exchange code for tokens; finalize.</li><li><code>POST /oauth/:provider/refresh</code> → Refresh token (server‑side, no UI). Integrates with TokenManager.</li><li><code>POST /oauth/:provider/revoke</code> → Revoke tokens (server‑side, audit).</li><li><code>GET /oauth/:provider/status</code> → Minimal session/connection status (redacted diagnostics; no secrets).</li><li><code>GET /oauth/:provider/retry</code> → Restart flow after recoverable error (UI page → redirect to <code>start</code>).</li></ul><p>Routing rules:</p><ul><li>RequestRouter maps <code>/:provider/*</code> to OAuthFlowController. FlowValidator checks provider enablement and policy before executing.</li><li>Circuit breakers and retry (Phase 4) wrap network calls to providers (discovery, token exchange). UI pages surface retry affordances.</li><li>Base path support (<code>/mcp/oauth/...</code>) for reverse proxies; use ConfigManager for <code>server.basePath</code>.</li></ul><hr><h2 id="oauth-flow-sequences" tabindex="-1">OAuth Flow Sequences <a class="header-anchor" href="#oauth-flow-sequences" aria-label="Permalink to &quot;OAuth Flow Sequences&quot;">​</a></h2><h3 id="_1-authorization-code-pkce-web" tabindex="-1">1) Authorization Code + PKCE (Web) <a class="header-anchor" href="#_1-authorization-code-pkce-web" aria-label="Permalink to &quot;1) Authorization Code + PKCE (Web)&quot;">​</a></h3><div class="language-mermaid vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant U as User Agent (Browser)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant M as Master (OAuthFlowController)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant ST as StateManager/PKCE</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant P as OAuth Provider</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant AU as MultiAuthManager</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  U-&gt;&gt;M: GET /oauth/github/start?redirect=/app</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  M-&gt;&gt;ST: issue state+nonce+pkce</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ST--&gt;&gt;M: {state, nonce, pkceHash, verifierCookie}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  M-&gt;&gt;P: 302 to authorize?client_id&amp;redirect_uri&amp;state&amp;code_challenge&amp;code_challenge_method=S256&amp;scope</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  U-&gt;&gt;P: GET /authorize ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  P--&gt;&gt;U: 302 back to M /callback?code&amp;state</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  U-&gt;&gt;M: GET /oauth/github/callback?code&amp;state</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  M-&gt;&gt;ST: validate state (single-use) + pull pkce hash + nonce</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ST--&gt;&gt;M: ok</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  M-&gt;&gt;P: POST /token { code, code_verifier, redirect_uri }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  P--&gt;&gt;M: { access_token, refresh_token, id_token?, expires_in }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  M-&gt;&gt;AU: save TokenBundle; establish session; link user</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  AU--&gt;&gt;M: ok</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  M--&gt;&gt;U: 302 to original redirect (/app) or success page</span></span></code></pre></div><p>State storage options: ephemeral keyed by <code>state</code> with TTL 10 minutes. Store hashed <code>code_verifier</code> (S256) rather than plaintext.</p><h3 id="_2-mobile-desktop-loopback-or-app-scheme" tabindex="-1">2) Mobile/Desktop (Loopback or App Scheme) <a class="header-anchor" href="#_2-mobile-desktop-loopback-or-app-scheme" aria-label="Permalink to &quot;2) Mobile/Desktop (Loopback or App Scheme)&quot;">​</a></h3><div class="language-mermaid vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant A as Native App</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant M as Master</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant ST as State/PKCE</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant P as Provider</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  A-&gt;&gt;M: GET /oauth/google/start?app_scheme=myapp://cb</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  M-&gt;&gt;ST: issue(state, pkce, nonce)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  M--&gt;&gt;A: 302 to P authorize (redirect_uri = myapp://cb) OR loopback http://127.0.0.1:port/callback</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  A-&gt;&gt;P: open authorize URL in system browser</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  P--&gt;&gt;A: redirect to myapp://cb?code&amp;state (OS hands control to app)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  A-&gt;&gt;M: POST /oauth/google/callback (in-app) with code, state (or app posts to loopback listener)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  M-&gt;&gt;ST: validate state+pkce</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  M-&gt;&gt;P: exchange code+verifier</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  P--&gt;&gt;M: tokens</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  M--&gt;&gt;A: success payload (deep link response or JSON)</span></span></code></pre></div><p>Notes:</p><ul><li>For public native clients, prefer app scheme or loopback redirect with PKCE. No client secret.</li><li>When app cannot receive inbound deep links, use loopback with ephemeral local server or out‑of‑band return URL with one‑time code exchange endpoint.</li></ul><h3 id="_3-delegation-on‐behalf‐of-backend" tabindex="-1">3) Delegation / On‑Behalf‑Of (Backend) <a class="header-anchor" href="#_3-delegation-on‐behalf‐of-backend" aria-label="Permalink to &quot;3) Delegation / On‑Behalf‑Of (Backend)&quot;">​</a></h3><div class="language-mermaid vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant Svc as Backend Service</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant M as Master (OAuth Delegation)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant P as Provider</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant AU as MultiAuthManager</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Svc-&gt;&gt;M: POST /oauth/:provider/start-delegation { subject, scopes }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  M-&gt;&gt;AU: resolve subject session/token</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  AU--&gt;&gt;M: subject context</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  M-&gt;&gt;P: RFC 8693 token exchange or provider-specific OBO</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  P--&gt;&gt;M: delegated access_token (+ refresh_token?)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  M-&gt;&gt;AU: persist as delegated TokenBundle scoped to service</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  M--&gt;&gt;Svc: { access_token, expires_in } (no refresh_token to caller by policy)</span></span></code></pre></div><p>Notes:</p><ul><li>Prefer RFC 8693 Token Exchange when supported; otherwise use provider OBO APIs (e.g., Azure AD <code>on_behalf_of</code>).</li><li>Delegated tokens are stored and rotated by Master; services receive short‑lived access tokens only.</li></ul><h3 id="_4-error-retry-flow" tabindex="-1">4) Error + Retry Flow <a class="header-anchor" href="#_4-error-retry-flow" aria-label="Permalink to &quot;4) Error + Retry Flow&quot;">​</a></h3><div class="language-mermaid vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant U as User</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant M as Master</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant P as Provider</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  U-&gt;&gt;M: GET /oauth/okta/callback?error=access_denied&amp;state=...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  M-&gt;&gt;M: map provider error → UX code (user_cancelled)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  M--&gt;&gt;U: render error page with retry link</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  U-&gt;&gt;M: GET /oauth/okta/retry?stateRef=prev</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  M-&gt;&gt;M: start new flow (fresh state/nonce/PKCE)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  M--&gt;&gt;U: 302 to provider authorize</span></span></code></pre></div><hr><h2 id="web-interface-architecture" tabindex="-1">Web Interface Architecture <a class="header-anchor" href="#web-interface-architecture" aria-label="Permalink to &quot;Web Interface Architecture&quot;">​</a></h2><h3 id="rendering-approach" tabindex="-1">Rendering Approach <a class="header-anchor" href="#rendering-approach" aria-label="Permalink to &quot;Rendering Approach&quot;">​</a></h3><ul><li>Templates: Use a small, logic‑lite, universal templating engine (Eta or Mustache). Precompile where possible for performance; runtime rendering works in Workers and Node.</li><li>Security: Escape by default; no untrusted HTML injection. Content Security Policy (CSP) with <code>default-src &#39;self&#39;; frame-ancestors &#39;none&#39;; base-uri &#39;none&#39;; form-action &#39;self&#39;</code> and nonced inline styles/scripts when absolutely necessary.</li><li>Delivery: Pages served by WebInterfaceRenderer via RequestRouter. Cache‑control set to <code>no-store</code> for auth pages.</li></ul><h3 id="page-types" tabindex="-1">Page Types <a class="header-anchor" href="#page-types" aria-label="Permalink to &quot;Page Types&quot;">​</a></h3><ul><li>Consent/Start Interstitial: Show provider name, scopes summary, and continue button; optional when UX requires.</li><li>Success Page: Friendly confirmation; auto‑redirect to <code>redirect</code> target with <code>window.location.replace()</code> using a nonced inline script.</li><li>Error Page: Clear categorization (cancelled, misconfigured, unavailable); includes retry and a support reference ID.</li><li>Status Page: Minimal, redacted session info for debugging (development only by default).</li></ul><h3 id="internationalization-i18n" tabindex="-1">Internationalization (i18n) <a class="header-anchor" href="#internationalization-i18n" aria-label="Permalink to &quot;Internationalization (i18n)&quot;">​</a></h3><ul><li>Locale detection: <code>Accept-Language</code>, <code>ui.lang</code> query param, or session. Fallback to <code>en</code>.</li><li>Resource bundles: JSON dictionaries under <code>i18n/&lt;locale&gt;.json</code> keyed by stable message IDs; loaded at startup via ConfigManager.</li><li>Pluralization/gender: Keep scope minimal; rely on ICU message format if needed in future iterations.</li></ul><h3 id="accessibility-and-ux" tabindex="-1">Accessibility and UX <a class="header-anchor" href="#accessibility-and-ux" aria-label="Permalink to &quot;Accessibility and UX&quot;">​</a></h3><ul><li>Semantic HTML; headings and landmarks; ARIA for dynamic content.</li><li>Full keyboard support; visible focus states; color-contrast compliant.</li><li>Motion reduced; respect <code>prefers-reduced-motion</code> and <code>prefers-color-scheme</code>.</li><li>Error pages describe resolution paths, avoid technical jargon, and never leak secrets.</li></ul><h3 id="branding-and-theming" tabindex="-1">Branding and Theming <a class="header-anchor" href="#branding-and-theming" aria-label="Permalink to &quot;Branding and Theming&quot;">​</a></h3><ul><li>Configurable provider display name, logo URL (fetched from allowlisted domains), and theme tokens (colors, dark mode).</li><li>High‑DPI safe images; alt text and localized content.</li></ul><hr><h2 id="security-architecture" tabindex="-1">Security Architecture <a class="header-anchor" href="#security-architecture" aria-label="Permalink to &quot;Security Architecture&quot;">​</a></h2><h3 id="pkce-for-public-clients" tabindex="-1">PKCE for Public Clients <a class="header-anchor" href="#pkce-for-public-clients" aria-label="Permalink to &quot;PKCE for Public Clients&quot;">​</a></h3><ul><li>Always prefer <code>S256</code> method. PKCEManager creates random 32–64 byte verifier, derives S256 challenge.</li><li>Store only a salted hash of the verifier in ephemeral state. Accept verifier only once during code exchange.</li></ul><h3 id="state-and-nonce-csrf-oidc" tabindex="-1">State and Nonce (CSRF/OIDC) <a class="header-anchor" href="#state-and-nonce-csrf-oidc" aria-label="Permalink to &quot;State and Nonce (CSRF/OIDC)&quot;">​</a></h3><ul><li>StateManager issues <code>state</code> with TTL (10 min) and marks single‑use on validation.</li><li>OIDC nonce bound to state and optionally user agent; validated against <code>id_token</code> claim.</li><li>Transport binding: bind state to an HttpOnly, Secure, SameSite=Lax cookie carrying a random session key; Store only the session key server‑side.</li></ul><h3 id="redirect-uri-validation" tabindex="-1">Redirect URI Validation <a class="header-anchor" href="#redirect-uri-validation" aria-label="Permalink to &quot;Redirect URI Validation&quot;">​</a></h3><ul><li>Strict allowlist per provider and environment. Exact string or prefix match only for trusted schemes: <code>https://</code> origins, <code>http://127.0.0.1</code> loopback, and registered custom app schemes.</li><li>Disallow dynamic hostnames unless explicitly allowlisted; reject mixed‑scheme or embedded credentials.</li></ul><h3 id="session-security-and-timeouts" tabindex="-1">Session Security and Timeouts <a class="header-anchor" href="#session-security-and-timeouts" aria-label="Permalink to &quot;Session Security and Timeouts&quot;">​</a></h3><ul><li>No tokens in query strings or page content. Access/refresh tokens never rendered to the browser.</li><li>Short‑lived flow state (10 min), session cookie rotation on completion, and logout revocation endpoint.</li><li>Idempotent callback handling: repeated <code>code</code> or <code>state</code> yields a safe error page without leaking existence of tokens.</li></ul><h3 id="headers-and-transport" tabindex="-1">Headers and Transport <a class="header-anchor" href="#headers-and-transport" aria-label="Permalink to &quot;Headers and Transport&quot;">​</a></h3><ul><li>HSTS, X‑Content‑Type‑Options, Referrer‑Policy, and frame busting via <code>frame-ancestors &#39;none&#39;</code>.</li><li>CSP nonces per page render; disallow inline scripts except with generated nonces.</li></ul><h3 id="abuse-prevention" tabindex="-1">Abuse Prevention <a class="header-anchor" href="#abuse-prevention" aria-label="Permalink to &quot;Abuse Prevention&quot;">​</a></h3><ul><li>Rate limits per IP/user on <code>/start</code> and <code>/callback</code>; exponential backoff after failures; optional CAPTCHA in high‑risk scenarios.</li><li>Replay protection by marking state consumed; store seen <code>code</code> values for a short TTL to detect and reject replay.</li></ul><h3 id="secrets-and-keys" tabindex="-1">Secrets and Keys <a class="header-anchor" href="#secrets-and-keys" aria-label="Permalink to &quot;Secrets and Keys&quot;">​</a></h3><ul><li>Integrates with Phase 6 SecretManager for provider client secrets (when used) and encryption keys.</li><li>All logs and metrics strictly redact tokens; include hashed references only.</li></ul><hr><h2 id="integration-with-existing-components" tabindex="-1">Integration with Existing Components <a class="header-anchor" href="#integration-with-existing-components" aria-label="Permalink to &quot;Integration with Existing Components&quot;">​</a></h2><ul><li>MultiAuthManager (Phase 2): CallbackHandler delivers TokenBundle and user identity; strategy emits AuthResult for session issuance. Refresh/revoke endpoints forward to TokenManager via strategy methods.</li><li>OAuthProviderRegistry (Phase 2): Provider discovery, JWKS, token endpoints abstracted. Provider‑specific parameters injected via configuration and per‑provider hooks.</li><li>RequestRouter (Phase 3–4): Registers OAuth endpoints; wraps network calls with retry/backoff and circuit breakers; preserves idempotency keys for callbacks.</li><li>ProtocolHandler (Phase 5): Exposes OAuth flow initiation as protocol actions if needed; allows tools to request authorization.</li><li>ConfigManager (Phase 5–6): Central source of truth for <code>auth.providers</code>, <code>ui.oauth</code>, <code>security.redirects</code>, <code>server.basePath</code>, <code>platform.*</code>.</li><li>DependencyContainer (Phase 5): Wires PKCEManager, StateManager store adapters, WebInterfaceRenderer engine, and FlowValidator policies.</li><li>Logging/Monitoring: Structured logs (<code>event=&#39;oauth.*&#39;</code>) and OpenTelemetry spans around key stages: <code>oauth.start</code>, <code>oauth.callback</code>, <code>oauth.exchange</code>, <code>oauth.refresh</code>, <code>oauth.revoke</code>.</li></ul><hr><h2 id="provider-specific-customization" tabindex="-1">Provider-Specific Customization <a class="header-anchor" href="#provider-specific-customization" aria-label="Permalink to &quot;Provider-Specific Customization&quot;">​</a></h2><p>Mechanisms:</p><ul><li>Per‑provider hook interface: <code>beforeAuthorize(params)</code>, <code>afterTokenExchange(bundle)</code>, <code>mapUserInfo(raw)</code>, <code>additionalHeaders()</code>.</li><li>Configurable extras injected into authorize request: e.g., Google <code>access_type=offline&amp;prompt=consent</code>, Azure AD <code>resource</code> or <code>tenant</code>, Okta <code>prompt</code>/<code>idp</code>.</li><li>Scope policy: allowlist + transform; FlowValidator enforces allowed scopes per provider/tenant.</li><li>Display: provider branding (name, logo, legal links), localized scope descriptions.</li></ul><p>Example authorize param assembly:</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> base</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { response_type: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;code&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, client_id, redirect_uri, scope: scopes.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">join</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39; &#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), state, code_challenge, code_challenge_method: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;S256&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> params</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> provider.beforeAuthorize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> provider.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">beforeAuthorize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(base, ctx) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> base;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> URLSearchParams</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(params);</span></span></code></pre></div><hr><h2 id="configuration-model-phase-6-integration" tabindex="-1">Configuration Model (Phase 6 Integration) <a class="header-anchor" href="#configuration-model-phase-6-integration" aria-label="Permalink to &quot;Configuration Model (Phase 6 Integration)&quot;">​</a></h2><p>Schema sketch (TypeScript/TypeBox style):</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> OAuthProviderSchema</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  id: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// &#39;github&#39;, &#39;google&#39;, &#39;azure&#39;, &#39;okta&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  kind: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Union</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([ Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Literal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;oidc&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Literal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;oauth2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) ], { default: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;oauth2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  clientId: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  clientSecret: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Optional</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(SecretRefSchema), </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// not used for public native clients</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  discoveryUrl: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Optional</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()), </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// for OIDC</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  authUrl: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Optional</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  tokenUrl: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Optional</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  revocationUrl: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Optional</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  jwksUrl: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Optional</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  defaultScopes: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), { default: [] }),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  allowedRedirects: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), { default: [] }),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  pkceRequired: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ default: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  extraAuthorizeParams: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), { default: {} }),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  branding: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ name: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), logoUrl: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Optional</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) }, { default: { name: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } }),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ui: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ theme: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Optional</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()), consentInterstitial: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ default: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }) }, { default: {} }),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> OAuthUiSchema</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  basePath: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ default: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;/oauth&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  i18n: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ defaultLocale: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ default: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;en&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }), supported: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Array</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), { default: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;en&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] }) }),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  csp: Type.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ default: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><hr><h2 id="storage-and-state-adapters" tabindex="-1">Storage and State Adapters <a class="header-anchor" href="#storage-and-state-adapters" aria-label="Permalink to &quot;Storage and State Adapters&quot;">​</a></h2><ul><li>Ephemeral State Store: Interface <code>EphemeralStore</code> with <code>get/set/delete</code> and TTL. Implementations: <ul><li>Node: In‑memory (dev), Redis (prod), or process‑local LRU with TTL for single‑node.</li><li>Workers: Cloudflare KV or Durable Objects (preferred for consistency).</li></ul></li><li>Session Binding: Session key kept in HttpOnly cookie; state entries are bound to this key to prevent CSRF.</li><li>Idempotency: Store processed <code>code</code> values for a short TTL to detect and reject replayed callbacks.</li></ul><hr><h2 id="mobile-and-responsive-design" tabindex="-1">Mobile and Responsive Design <a class="header-anchor" href="#mobile-and-responsive-design" aria-label="Permalink to &quot;Mobile and Responsive Design&quot;">​</a></h2><ul><li>Responsive Layout: Fluid grid and typography; tap targets ≥44px; safe areas on iOS; respect <code>viewport-fit=cover</code>.</li><li>Deep Links: <code>myapp://callback</code> support with allowlist; provide QR fallback for desktop‑to‑mobile handoff in CLI scenarios.</li><li>Loopback: <code>http://127.0.0.1:&lt;random-port&gt;/callback</code> for desktop/CLI; require PKCE and strict 127.0.0.1 host.</li><li>Copy‑code Fallback: Render a one‑time code and link to paste into app if deep link fails.</li></ul><hr><h2 id="error-handling-and-ux-flows" tabindex="-1">Error Handling and UX Flows <a class="header-anchor" href="#error-handling-and-ux-flows" aria-label="Permalink to &quot;Error Handling and UX Flows&quot;">​</a></h2><p>Error taxonomy:</p><ul><li>user_cancelled: User denied consent or closed the window.</li><li>provider_unavailable: Network/provider outage; suggest retry.</li><li>misconfiguration: Redirect, client, or scope mismatch; show admin contact instructions.</li><li>state_invalid | nonce_invalid | pkce_invalid: Security failures; encourage restart; audit at high severity.</li><li>already_linked | session_expired: Provide clear next steps.</li></ul><p>UX rules:</p><ul><li>Always provide a safe retry path that issues a fresh state/nonce/PKCE.</li><li>Never display raw provider errors or secrets; map to friendly codes with support reference ID.</li><li>Include back link to application, preserving original intent where possible.</li></ul><hr><h2 id="observability-and-audit" tabindex="-1">Observability and Audit <a class="header-anchor" href="#observability-and-audit" aria-label="Permalink to &quot;Observability and Audit&quot;">​</a></h2><ul><li>Logs: <code>event=&#39;oauth.start&#39; | &#39;oauth.callback&#39; | &#39;oauth.exchange&#39; | &#39;oauth.refresh&#39; | &#39;oauth.revoke&#39; | &#39;oauth.error&#39;</code> with fields: <code>provider</code>, <code>tenant</code>, <code>userKeyHash</code>, <code>stateId</code>, <code>result</code>, <code>durationMs</code>. All tokens redacted.</li><li>Metrics: counters/gauges: <code>oauth_start_total</code>, <code>oauth_callback_total</code>, <code>oauth_exchange_errors_total{reason}</code>, <code>oauth_latency_ms{stage}</code>.</li><li>Tracing: Spans around provider calls; attributes: <code>oauth.provider</code>, <code>oauth.scopes</code>, <code>oauth.redirect_origin</code>.</li><li>Audit: Append‑only records for token issuance/revocation and delegation/OBO with actor and scope details.</li></ul><hr><h2 id="cross‐platform-deployment" tabindex="-1">Cross‑Platform Deployment <a class="header-anchor" href="#cross‐platform-deployment" aria-label="Permalink to &quot;Cross‑Platform Deployment&quot;">​</a></h2><p>Node.js (server/process):</p><ul><li>Use filesystem templates bundled at build; Redis or in‑memory state store; HTTPS termination via reverse proxy.</li><li>Support loopback redirect for desktop/CLI; ensure <code>127.0.0.1</code> hosts only.</li></ul><p>Cloudflare Workers / Edge:</p><ul><li>Use precompiled templates or inline templates; KV/DO for state; fetch‑based HTTP; no Node‑specific APIs.</li><li>Avoid libraries that require Node crypto; rely on WebCrypto for PKCE hashing and nonce.</li></ul><p>Containers / Proxies:</p><ul><li>Respect <code>X-Forwarded-*</code> and <code>Forwarded</code> headers for redirect URL construction; validate <code>publicBaseUrl</code> from config.</li><li>Honor <code>server.basePath</code> for path rewriting; generate absolute redirect URIs consistently.</li></ul><p>Multi‑tenant:</p><ul><li>Namespace state entries by tenant; isolate provider configs; per‑tenant branding and allowlists.</li></ul><hr><h2 id="minimal-interfaces-typescript-sketch" tabindex="-1">Minimal Interfaces (TypeScript Sketch) <a class="header-anchor" href="#minimal-interfaces-typescript-sketch" aria-label="Permalink to &quot;Minimal Interfaces (TypeScript Sketch)&quot;">​</a></h2><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OAuthFlowController</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HttpRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HttpResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  callback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HttpRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HttpResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  retry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">req</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HttpRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HttpResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PKCEManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  issue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;{ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">verifier</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">challenge</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">method</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;S256&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">hash</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }&gt;;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  validate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">verifier</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">expectedHash</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> StateManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  issue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">input</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">provider</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">redirect</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">nonce</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">codeVerifierHash</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sessionKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ttlSec</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> })</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;{ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">state</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ttlSec</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">nonce</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }&gt;;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  validate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">state</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sessionKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;{ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">provider</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">redirect</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">nonce</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">codeVerifierHash</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }&gt;;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  invalidate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CallbackHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">input</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">providerId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">code</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">verifier</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">redirectUri</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">stateRef</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> })</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;{ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tokens</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TokenBundle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">user</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UserInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> WebInterfaceRenderer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  render</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">page</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;consent&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;success&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;error&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;status&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">model</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Record</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">unknown</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">locale</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HttpResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FlowValidator</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  providerEnabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">providerId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  redirectAllowed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">providerId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">redirect</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// returns normalized URI</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  scopesAllowed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">providerId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">scopes</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[])</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  pkceRequired</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">providerId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h2 id="sequence-integration-with-multiauthmanager" tabindex="-1">Sequence Integration with MultiAuthManager <a class="header-anchor" href="#sequence-integration-with-multiauthmanager" aria-label="Permalink to &quot;Sequence Integration with MultiAuthManager&quot;">​</a></h2><div class="language-mermaid vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sequenceDiagram</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant C as Client</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant F as OAuthFlowController</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant V as FlowValidator</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant S as State/PKCE</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant R as OAuthProviderRegistry</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant P as Provider</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  participant M as MultiAuthManager</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  C-&gt;&gt;F: GET /oauth/:provider/start</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  F-&gt;&gt;V: providerEnabled + redirectAllowed</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  F-&gt;&gt;S: issue(state, pkce)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  F-&gt;&gt;R: get(provider)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  F--&gt;&gt;C: 302 to provider authorize</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  C-&gt;&gt;F: GET /oauth/:provider/callback?code&amp;state</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  F-&gt;&gt;S: validate(state)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  F-&gt;&gt;P: exchange(code, verifier)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  P--&gt;&gt;F: TokenBundle</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  F-&gt;&gt;M: save tokens + create session</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  M--&gt;&gt;F: ok</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  F--&gt;&gt;C: redirect to app success</span></span></code></pre></div><hr><h2 id="implementation-notes-and-defaults" tabindex="-1">Implementation Notes and Defaults <a class="header-anchor" href="#implementation-notes-and-defaults" aria-label="Permalink to &quot;Implementation Notes and Defaults&quot;">​</a></h2><ul><li>PKCE: Enforce S256; reject <code>plain</code> except in explicitly allowed dev mode.</li><li>State TTL: 10 minutes default; configurable per provider.</li><li>Idempotency: Store hash(code) for 10 minutes after success; repeated callbacks return success page or no‑op.</li><li>CSP: Enabled by default; nonce injected via DependencyContainer’s crypto service.</li><li>Templates: Prefer precompiled Eta templates packaged under <code>assets/templates/oauth/*.eta</code>.</li><li>Errors: Map provider error codes to internal taxonomy; include <code>supportRefId</code> (KSUID/ULID) in UI and logs.</li></ul><hr><h2 id="deliverables-coverage-checklist" tabindex="-1">Deliverables Coverage Checklist <a class="header-anchor" href="#deliverables-coverage-checklist" aria-label="Permalink to &quot;Deliverables Coverage Checklist&quot;">​</a></h2><ul><li>Detailed flow components and interfaces (OAuthFlowController, PKCEManager, StateManager, CallbackHandler, WebInterfaceRenderer, FlowValidator).</li><li>OAuth flow types: Auth Code + PKCE, delegation/OBO, provider customizations, mobile and error/retry flows.</li><li>Web interface architecture: templating, branding, i18n, accessibility, security UX.</li><li>Security architecture: PKCE, state, nonce, redirect validation, headers, replay protection.</li><li>Integration patterns with Phase 2–6 components; routing and observability.</li><li>Cross‑platform differences: Node, Workers, containers/proxies, multi‑tenant.</li><li>Multiple sequence diagrams covering core and edge flows.</li></ul><hr><h2 id="appendix-example-error-mapping-table-excerpt" tabindex="-1">Appendix: Example Error Mapping Table (excerpt) <a class="header-anchor" href="#appendix-example-error-mapping-table-excerpt" aria-label="Permalink to &quot;Appendix: Example Error Mapping Table (excerpt)&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Provider error</th><th>Internal code</th><th>HTTP</th><th>UX Message Key</th></tr></thead><tbody><tr><td>access_denied</td><td>user_cancelled</td><td>302</td><td>oauth.error.userCancelled</td></tr><tr><td>server_error</td><td>provider_unavailable</td><td>503</td><td>oauth.error.providerDown</td></tr><tr><td>invalid_client</td><td>misconfiguration</td><td>500</td><td>oauth.error.misconfigured</td></tr><tr><td>invalid_state</td><td>state_invalid</td><td>400</td><td>oauth.error.stateInvalid</td></tr><tr><td>invalid_nonce</td><td>nonce_invalid</td><td>400</td><td>oauth.error.nonceInvalid</td></tr></tbody></table>`,112)]))}const E=i(t,[["render",l]]);export{c as __pageData,E as default};
